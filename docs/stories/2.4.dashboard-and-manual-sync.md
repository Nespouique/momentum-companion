# Story 2.4: Dashboard et sync manuel

## Status: Draft

## Story
**As a** user,
**I want** to see my daily metrics and be able to trigger a manual sync,
**so that** I can verify everything is working and see my progress at a glance.

## Acceptance Criteria
1. L'ecran dashboard (Screen 3) affiche les 3 anneaux du jour (pas, minutes activite, calories) avec progression vers l'objectif
2. Les objectifs sont recuperes depuis l'API Momentum (`GET /api/v1/health-sync/status`)
3. Les valeurs actuelles sont lues directement depuis Health Connect (pas d'appel API pour l'affichage local)
4. Le statut de connexion et la date du dernier sync sont affiches
5. Le bouton "Synchroniser maintenant" declenche un `OneTimeWorkRequest` immediat
6. La liste des activites du jour est affichee sous les anneaux
7. Un pull-to-refresh rafraichit les donnees locales Health Connect

## Tasks / Subtasks
- [ ] Creer DashboardScreen composable (AC: #1, #4)
  - [ ] `ui/dashboard/DashboardScreen.kt` avec layout principal
  - [ ] Header avec nom de l'app et bouton settings (gear icon)
  - [ ] Bandeau statut connexion : "Connecte a {serverUrl}" + "Dernier sync : il y a X min"
  - [ ] Section "Aujourd'hui" avec les 3 barres de progression
  - [ ] Bouton "Synchroniser maintenant"
  - [ ] Section activites du jour
- [ ] Creer DashboardViewModel (AC: #2, #3, #4, #5, #7)
  - [ ] `ui/dashboard/DashboardViewModel.kt`
  - [ ] State: UiState avec currentSteps, currentCalories, currentMinutes, goalSteps, goalCalories, goalMinutes, lastSync, activities, isLoading, isSyncing
  - [ ] Charger les goals depuis l'API au lancement
  - [ ] Charger les valeurs actuelles depuis Health Connect
  - [ ] Methode syncNow() via SyncScheduler
  - [ ] Methode refresh() pour pull-to-refresh
- [ ] Implementer les barres de progression (AC: #1)
  - [ ] `ui/dashboard/components/MetricProgressBar.kt`
  - [ ] Barre lineaire coloree (vert=pas, bleu=minutes, rouge=calories)
  - [ ] Label "X / Y unit" + pourcentage
  - [ ] Icone a gauche de chaque barre
- [ ] Implementer la liste des activites du jour (AC: #6)
  - [ ] `ui/dashboard/components/ActivityItem.kt`
  - [ ] Afficher heure de debut, type d'activite, duree, distance (si dispo)
  - [ ] Lire les ExerciseSessionRecord du jour depuis Health Connect
- [ ] Implementer le pull-to-refresh (AC: #7)
  - [ ] Utiliser `pullRefresh` modifier de Material3
  - [ ] Recharger les donnees Health Connect locales
  - [ ] Ne PAS declencher un sync API (juste rafraichir l'affichage local)
- [ ] Implementer le bouton sync manuel (AC: #5)
  - [ ] Appeler SyncScheduler.syncNow()
  - [ ] Observer le WorkInfo pour afficher l'etat (en cours / succes / erreur)
  - [ ] Rafraichir les donnees locales apres sync reussi
- [ ] Ecrire les tests unitaires
  - [ ] `DashboardViewModelTest.kt` : mock HealthConnectReader, API, SyncScheduler

## Dev Notes

### Dashboard UI Wireframe (Screen 3)
```
+----------------------------------+
|  MOMENTUM COMPANION    [gear]    |
|                                  |
|  [green dot] Connecte a          |
|  momentum.local                  |
|  Dernier sync : il y a 12 min   |
|                                  |
|  +----- Aujourd'hui -----------+ |
|  |                             | |
|  |  [walk] 8 432 / 10 000 pas | |
|  |  [============--] 84%      | |
|  |                             | |
|  |  [timer] 62 / 90 min       | |
|  |  [=========-----] 69%      | |
|  |                             | |
|  |  [flame] 385 / 500 kcal    | |
|  |  [==========----] 77%      | |
|  +-----------------------------+ |
|                                  |
|  [ SYNCHRONISER MAINTENANT  ]   |
|                                  |
|  Activites aujourd'hui :         |
|  07:00 - Marche (45 min, 3.2km) |
|  12:30 - Musculation (62 min)   |
+----------------------------------+
```

### DashboardScreen Implementation

**File**: `app/src/main/java/com/momentum/companion/ui/dashboard/DashboardScreen.kt`

```kotlin
package com.momentum.companion.ui.dashboard

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.material3.*
import androidx.compose.material3.pulltorefresh.PullToRefreshBox
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun DashboardScreen(
    onSettingsClick: () -> Unit,
    viewModel: DashboardViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsState()

    PullToRefreshBox(
        isRefreshing = uiState.isRefreshing,
        onRefresh = { viewModel.refresh() }
    ) {
        LazyColumn(
            modifier = Modifier
                .fillMaxSize()
                .padding(16.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // Header
            item { DashboardHeader(onSettingsClick = onSettingsClick) }

            // Connection status
            item {
                ConnectionStatus(
                    serverUrl = uiState.serverUrl,
                    lastSync = uiState.lastSyncFormatted,
                    isConnected = uiState.isConnected
                )
            }

            // Today's metrics card
            item {
                TodayMetricsCard(
                    steps = uiState.currentSteps,
                    stepsGoal = uiState.goalSteps,
                    activeMinutes = uiState.currentMinutes,
                    activeMinutesGoal = uiState.goalMinutes,
                    calories = uiState.currentCalories,
                    caloriesGoal = uiState.goalCalories
                )
            }

            // Sync button
            item {
                SyncNowButton(
                    isSyncing = uiState.isSyncing,
                    onClick = { viewModel.syncNow() }
                )
            }

            // Activities header
            if (uiState.todayActivities.isNotEmpty()) {
                item {
                    Text(
                        "Activites aujourd'hui :",
                        style = MaterialTheme.typography.titleMedium
                    )
                }
            }

            // Activity list
            items(uiState.todayActivities) { activity ->
                ActivityItem(activity = activity)
            }
        }
    }
}
```

### DashboardViewModel Implementation

**File**: `app/src/main/java/com/momentum/companion/ui/dashboard/DashboardViewModel.kt`

```kotlin
package com.momentum.companion.ui.dashboard

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.momentum.companion.data.api.MomentumApiService
import com.momentum.companion.data.healthconnect.HealthConnectReader
import com.momentum.companion.data.preferences.AppPreferences
import com.momentum.companion.sync.SyncScheduler
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import java.time.Duration
import java.time.Instant
import java.time.LocalDate
import javax.inject.Inject

data class DashboardUiState(
    val serverUrl: String = "",
    val isConnected: Boolean = false,
    val lastSyncFormatted: String = "Jamais",
    val currentSteps: Int = 0,
    val goalSteps: Int = 10000,
    val currentMinutes: Int = 0,
    val goalMinutes: Int = 90,
    val currentCalories: Int = 0,
    val goalCalories: Int = 500,
    val todayActivities: List<TodayActivity> = emptyList(),
    val isRefreshing: Boolean = false,
    val isSyncing: Boolean = false,
    val error: String? = null
)

data class TodayActivity(
    val startTime: String,      // "07:00"
    val activityType: String,   // "Marche"
    val durationMinutes: Int,
    val distanceKm: Double?,    // null if not available
)

@HiltViewModel
class DashboardViewModel @Inject constructor(
    private val healthConnectReader: HealthConnectReader,
    private val apiService: MomentumApiService,
    private val preferences: AppPreferences,
    private val syncScheduler: SyncScheduler
) : ViewModel() {

    private val _uiState = MutableStateFlow(DashboardUiState())
    val uiState: StateFlow<DashboardUiState> = _uiState.asStateFlow()

    init {
        loadData()
    }

    fun refresh() {
        viewModelScope.launch {
            _uiState.value = _uiState.value.copy(isRefreshing = true)
            loadHealthConnectData()
            _uiState.value = _uiState.value.copy(isRefreshing = false)
        }
    }

    fun syncNow() {
        viewModelScope.launch {
            _uiState.value = _uiState.value.copy(isSyncing = true)
            syncScheduler.syncNow()
            // After sync, refresh local data
            loadHealthConnectData()
            _uiState.value = _uiState.value.copy(isSyncing = false)
        }
    }

    private fun loadData() {
        viewModelScope.launch {
            // Load server info from preferences
            _uiState.value = _uiState.value.copy(
                serverUrl = preferences.serverUrl ?: "",
                isConnected = preferences.isConfigured,
                lastSyncFormatted = formatLastSync(preferences.lastSyncTimestamp)
            )

            // Load goals from API
            loadGoals()

            // Load current values from Health Connect
            loadHealthConnectData()
        }
    }

    private suspend fun loadGoals() { /* fetch from GET /api/v1/health-sync/status */ }
    private suspend fun loadHealthConnectData() { /* read today's data from Health Connect */ }
    private fun formatLastSync(timestamp: Long): String { /* format relative time */ }
}
```

### MetricProgressBar Component

**File**: `app/src/main/java/com/momentum/companion/ui/dashboard/components/MetricProgressBar.kt`

```kotlin
package com.momentum.companion.ui.dashboard.components

import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.unit.dp

@Composable
fun MetricProgressBar(
    label: String,
    currentValue: Int,
    goalValue: Int,
    unit: String,
    color: Color,
    icon: @Composable () -> Unit,
    modifier: Modifier = Modifier
) {
    val progress = if (goalValue > 0) {
        (currentValue.toFloat() / goalValue).coerceIn(0f, 1f)
    } else 0f

    val percentage = (progress * 100).toInt()

    Column(modifier = modifier.fillMaxWidth()) {
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Row(verticalAlignment = Alignment.CenterVertically) {
                icon()
                Spacer(modifier = Modifier.width(8.dp))
                Text(
                    text = "$currentValue / $goalValue $unit",
                    style = MaterialTheme.typography.bodyMedium
                )
            }
            Text(
                text = "$percentage%",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
        Spacer(modifier = Modifier.height(4.dp))
        LinearProgressIndicator(
            progress = { progress },
            modifier = Modifier
                .fillMaxWidth()
                .height(8.dp),
            color = color,
            trackColor = color.copy(alpha = 0.2f),
        )
    }
}
```

Usage in the Today card:
```kotlin
// Steps - Green
MetricProgressBar(
    label = "Pas",
    currentValue = uiState.currentSteps,
    goalValue = uiState.goalSteps,
    unit = "pas",
    color = MomentumGreen,  // #22C55E
    icon = { Icon(Icons.Default.DirectionsWalk, contentDescription = "Pas") }
)

// Active Minutes - Blue
MetricProgressBar(
    label = "Minutes d'activite",
    currentValue = uiState.currentMinutes,
    goalValue = uiState.goalMinutes,
    unit = "min",
    color = MomentumBlue,   // #3B82F6
    icon = { Icon(Icons.Default.Timer, contentDescription = "Minutes") }
)

// Calories - Red
MetricProgressBar(
    label = "Calories actives",
    currentValue = uiState.currentCalories,
    goalValue = uiState.goalCalories,
    unit = "kcal",
    color = MomentumRed,    // #EF4444
    icon = { Icon(Icons.Default.LocalFireDepartment, contentDescription = "Calories") }
)
```

### Reading Today's Data from Health Connect

The dashboard reads directly from Health Connect for instant display (no network round-trip). This gives the user the freshest data available on the device.

```kotlin
private suspend fun loadHealthConnectData() {
    try {
        val today = LocalDate.now()

        // Steps
        val steps = healthConnectReader.readSteps(today, today)
        val todaySteps = steps[today]?.toInt() ?: 0

        // Calories
        val calories = healthConnectReader.readActiveCalories(today, today)
        val todayCalories = calories[today]?.toInt() ?: 0

        // Active minutes (from exercise sessions)
        val exercises = healthConnectReader.readExerciseSessions(today, today)
        val todayMinutes = exercises.sumOf { session ->
            Duration.between(session.startTime, session.endTime).toMinutes()
        }.toInt()

        // Map exercise sessions for the activity list
        val activities = exercises.map { session ->
            val zone = ZoneId.systemDefault()
            TodayActivity(
                startTime = session.startTime.atZone(zone)
                    .toLocalTime().format(DateTimeFormatter.ofPattern("HH:mm")),
                activityType = mapExerciseTypeToLabel(session.exerciseType),
                durationMinutes = Duration.between(session.startTime, session.endTime)
                    .toMinutes().toInt(),
                distanceKm = null  // Requires separate aggregate
            )
        }

        _uiState.value = _uiState.value.copy(
            currentSteps = todaySteps,
            currentCalories = todayCalories,
            currentMinutes = todayMinutes,
            todayActivities = activities
        )
    } catch (e: Exception) {
        _uiState.value = _uiState.value.copy(
            error = "Erreur de lecture Health Connect: ${e.message}"
        )
    }
}
```

### Goal Loading from API

Goals come from the Momentum API via `GET /api/v1/health-sync/status`:
```json
{
  "configured": true,
  "lastSync": "2026-02-05T08:30:00Z",
  "trackables": {
    "steps": { "id": "uuid", "goalValue": 10000 },
    "activeCalories": { "id": "uuid", "goalValue": 500 },
    "activeMinutes": { "id": "uuid", "goalValue": 90 },
    "sleepScore": { "id": "uuid", "goalValue": null }
  }
}
```

```kotlin
private suspend fun loadGoals() {
    try {
        val token = preferences.jwtToken ?: return
        val status = apiService.getSyncStatus("Bearer $token")
        _uiState.value = _uiState.value.copy(
            goalSteps = status.trackables?.steps?.goalValue ?: 10000,
            goalCalories = status.trackables?.activeCalories?.goalValue ?: 500,
            goalMinutes = status.trackables?.activeMinutes?.goalValue ?: 90
        )
    } catch (e: Exception) {
        // Use default goals if API is unreachable
    }
}
```

### Manual Sync with WorkManager OneTimeWorkRequest

The "Synchroniser maintenant" button triggers an immediate sync via `SyncScheduler.syncNow()`. The UI observes the work state:

```kotlin
fun syncNow() {
    viewModelScope.launch {
        _uiState.value = _uiState.value.copy(isSyncing = true)
        val workRequest = syncScheduler.syncNow()

        // Observe work completion (simplified - in practice, observe WorkInfo LiveData)
        // After a brief delay, refresh local data
        kotlinx.coroutines.delay(2000)
        loadHealthConnectData()
        _uiState.value = _uiState.value.copy(
            isSyncing = false,
            lastSyncFormatted = formatLastSync(System.currentTimeMillis())
        )
    }
}
```

For more robust observation, convert `WorkManager.getWorkInfoByIdLiveData()` to a Flow:
```kotlin
workManager.getWorkInfoByIdFlow(workRequest.id).collect { workInfo ->
    when (workInfo?.state) {
        WorkInfo.State.SUCCEEDED -> { /* refresh UI */ }
        WorkInfo.State.FAILED -> { /* show error */ }
        WorkInfo.State.RUNNING -> { /* show spinner */ }
        else -> {}
    }
}
```

### Pull-to-Refresh

Pull-to-refresh only reloads data from the local Health Connect store. It does NOT trigger an API sync. This keeps the interaction fast and avoids unnecessary network calls.

```kotlin
// In DashboardScreen.kt
PullToRefreshBox(
    isRefreshing = uiState.isRefreshing,
    onRefresh = { viewModel.refresh() }
) {
    LazyColumn { /* ... */ }
}
```

### Exercise Type Display Labels

Map Health Connect exercise types to user-friendly French labels:
```kotlin
fun mapExerciseTypeToLabel(type: Int): String = when (type) {
    ExerciseSessionRecord.EXERCISE_TYPE_WALKING -> "Marche"
    ExerciseSessionRecord.EXERCISE_TYPE_RUNNING -> "Course"
    ExerciseSessionRecord.EXERCISE_TYPE_BIKING -> "Velo"
    ExerciseSessionRecord.EXERCISE_TYPE_SWIMMING_OPEN_WATER -> "Natation"
    ExerciseSessionRecord.EXERCISE_TYPE_WEIGHTLIFTING -> "Musculation"
    ExerciseSessionRecord.EXERCISE_TYPE_YOGA -> "Yoga"
    ExerciseSessionRecord.EXERCISE_TYPE_HIKING -> "Randonnee"
    ExerciseSessionRecord.EXERCISE_TYPE_ELLIPTICAL -> "Elliptique"
    ExerciseSessionRecord.EXERCISE_TYPE_STAIR_CLIMBING -> "Escaliers"
    else -> "Autre"
}
```

### Relative Time Formatting

Format the last sync timestamp as a relative time string:
```kotlin
private fun formatLastSync(timestamp: Long): String {
    if (timestamp == 0L) return "Jamais"
    val now = System.currentTimeMillis()
    val diff = now - timestamp
    val minutes = diff / 60_000
    return when {
        minutes < 1 -> "A l'instant"
        minutes < 60 -> "il y a $minutes min"
        minutes < 1440 -> "il y a ${minutes / 60}h"
        else -> "il y a ${minutes / 1440}j"
    }
}
```

### Navigation Integration

In `NavGraph.kt`, wire the DashboardScreen:
```kotlin
composable(Screen.Dashboard.route) {
    DashboardScreen(
        onSettingsClick = { navController.navigate(Screen.Settings.route) }
    )
}
```

### Important Gotchas
- **Health Connect data freshness**: Samsung Health may take 5-15 minutes to push data to Health Connect. The dashboard may show slightly stale data. The pull-to-refresh re-reads from Health Connect but cannot force Samsung Health to sync
- **Goals default values**: If the API is unreachable, use hardcoded defaults (10000 steps, 90 min, 500 kcal) matching the Momentum trackable defaults
- **Empty state**: If Health Connect permissions are not granted, show a message directing the user to grant permissions instead of empty progress bars

### Testing
- Test framework: JUnit 5 + MockK
- Test location: `app/src/test/java/com/momentum/companion/`
- **DashboardViewModelTest.kt**:
  - Mock `HealthConnectReader` returning known values
  - Mock `MomentumApiService.getSyncStatus()` returning known goals
  - Verify UI state reflects correct current/goal values
  - Verify progress percentage calculation (e.g., 8432/10000 = 84%)
  - Test refresh() updates state from Health Connect
  - Test syncNow() triggers SyncScheduler
  - Test formatLastSync() produces correct relative time strings
  - Test error handling when Health Connect read fails

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1 | Initial creation | James (Dev) |

## Dev Agent Record
### Agent Model Used
[To be filled during implementation]

### Debug Log References
[None]

### Completion Notes
[None]

### File List
[To be populated during implementation]
