# Story 1.1: Setup projet et ecran de configuration

## Status: Implemented

## Story
**As a** user,
**I want** to configure my companion app with the URL of my Momentum server and my credentials,
**so that** I can connect the app to my self-hosted instance.

## Acceptance Criteria
1. Le projet Android est initialise avec Kotlin, Jetpack Compose, Hilt, et le theme sombre
2. L'ecran de setup (Screen 1) permet de saisir l'URL du serveur, l'email et le mot de passe
3. Le bouton "Tester la connexion" appelle `POST /auth/login` et affiche le resultat (succes/erreur)
4. En cas de succes, le token JWT et les credentials sont stockes dans EncryptedSharedPreferences
5. L'app gere le refresh de token JWT automatiquement
6. L'URL du serveur accepte les certificats self-signed (option configurable) car le serveur est self-hosted
7. La navigation redirige vers le setup si aucun serveur n'est configure

## Tasks / Subtasks
- [ ] Initialiser le projet Android avec les dependances (AC: #1)
  - [ ] Configurer `build.gradle.kts` (root + app) avec toutes les dependances
  - [ ] Configurer Hilt (`MomentumApp.kt`, `AppModule.kt`)
  - [ ] Configurer kotlinx.serialization
- [ ] Creer le theme Compose dark (AC: #1)
  - [ ] `ui/theme/Theme.kt` avec couleurs Momentum (background #0a0a0a, accent orange)
  - [ ] `ui/theme/Color.kt` et `ui/theme/Type.kt`
- [ ] Creer l'ecran de setup (AC: #2)
  - [ ] `ui/setup/SetupScreen.kt` avec 3 champs (URL, email, password)
  - [ ] `ui/setup/SetupViewModel.kt` avec state management
  - [ ] Validation des champs (URL valide, email non-vide, password non-vide)
- [ ] Implementer le test de connexion (AC: #3)
  - [ ] `data/api/MomentumApiService.kt` avec Retrofit interface
  - [ ] Appel `POST /auth/login` avec email/password
  - [ ] Affichage du resultat (succes/erreur) dans un snackbar ou banner
- [ ] Implementer le stockage securise (AC: #4)
  - [ ] `data/preferences/AppPreferences.kt` avec EncryptedSharedPreferences
  - [ ] Stocker : serverUrl, email, encryptedPassword, jwtToken, tokenExpiry
- [ ] Implementer la gestion du token JWT (AC: #5)
  - [ ] Intercepteur OkHttp pour ajouter le Bearer token
  - [ ] Intercepteur pour detecter 401 et re-login automatiquement
- [ ] Supporter les certificats self-signed (AC: #6)
  - [ ] Toggle "Accepter les certificats self-signed" sur l'ecran setup
  - [ ] OkHttpClient custom avec TrustManager permissif quand active
- [ ] Configurer la navigation (AC: #7)
  - [ ] `navigation/NavGraph.kt` avec routes : setup, dashboard, settings
  - [ ] `MainActivity.kt` verifie si configure et redirige vers setup ou dashboard

## Dev Notes

### Gradle Dependencies (app/build.gradle.kts)
```kotlin
plugins {
    id("com.android.application")
    id("org.jetbrains.kotlin.android")
    id("org.jetbrains.kotlin.plugin.serialization")
    id("com.google.dagger.hilt.android")
    id("com.google.devtools.ksp")
}

android {
    namespace = "com.momentum.companion"
    compileSdk = 35

    defaultConfig {
        applicationId = "com.momentum.companion"
        minSdk = 34
        targetSdk = 35
        versionCode = 1
        versionName = "1.0.0"
    }

    buildFeatures {
        compose = true
    }

    composeOptions {
        kotlinCompilerExtensionVersion = "1.5.14"
    }
}

dependencies {
    // Compose BOM
    val composeBom = platform("androidx.compose:compose-bom:2024.12.01")
    implementation(composeBom)
    implementation("androidx.compose.ui:ui")
    implementation("androidx.compose.material3:material3")
    implementation("androidx.compose.ui:ui-tooling-preview")
    implementation("androidx.activity:activity-compose:1.9.3")
    implementation("androidx.navigation:navigation-compose:2.8.5")
    implementation("androidx.lifecycle:lifecycle-viewmodel-compose:2.8.7")
    implementation("androidx.lifecycle:lifecycle-runtime-compose:2.8.7")
    debugImplementation("androidx.compose.ui:ui-tooling")

    // Hilt
    implementation("com.google.dagger:hilt-android:2.53.1")
    ksp("com.google.dagger:hilt-compiler:2.53.1")
    implementation("androidx.hilt:hilt-navigation-compose:1.2.0")
    implementation("androidx.hilt:hilt-work:1.2.0")
    ksp("androidx.hilt:hilt-compiler:1.2.0")

    // Retrofit + OkHttp
    implementation("com.squareup.retrofit2:retrofit:2.11.0")
    implementation("com.squareup.okhttp3:okhttp:4.12.0")
    implementation("com.squareup.okhttp3:logging-interceptor:4.12.0")

    // kotlinx.serialization
    implementation("org.jetbrains.kotlinx:kotlinx-serialization-json:1.7.3")
    implementation("com.jakewharton.retrofit:retrofit2-kotlinx-serialization-converter:1.0.0")

    // EncryptedSharedPreferences
    implementation("androidx.security:security-crypto:1.1.0-alpha06")

    // Health Connect
    implementation("androidx.health.connect:connect-client:1.1.0-alpha10")

    // WorkManager
    implementation("androidx.work:work-runtime-ktx:2.10.0")

    // Testing
    testImplementation("junit:junit:4.13.2")
    testImplementation("org.junit.jupiter:junit-jupiter:5.10.3")
    testImplementation("io.mockk:mockk:1.13.13")
    testImplementation("org.jetbrains.kotlinx:kotlinx-coroutines-test:1.9.0")
}
```

### Root build.gradle.kts
```kotlin
plugins {
    id("com.android.application") version "8.7.3" apply false
    id("org.jetbrains.kotlin.android") version "2.0.21" apply false
    id("org.jetbrains.kotlin.plugin.serialization") version "2.0.21" apply false
    id("com.google.dagger.hilt.android") version "2.53.1" apply false
    id("com.google.devtools.ksp") version "2.0.21-1.0.28" apply false
}
```

### Hilt Setup

**MomentumApp.kt** (`app/src/main/java/com/momentum/companion/MomentumApp.kt`):
```kotlin
package com.momentum.companion

import android.app.Application
import dagger.hilt.android.HiltAndroidApp

@HiltAndroidApp
class MomentumApp : Application()
```

**AppModule.kt** (`app/src/main/java/com/momentum/companion/di/AppModule.kt`):
```kotlin
package com.momentum.companion.di

import android.content.Context
import com.momentum.companion.data.api.MomentumApiService
import com.momentum.companion.data.preferences.AppPreferences
import dagger.Module
import dagger.Provides
import dagger.hilt.InstallIn
import dagger.hilt.android.qualifiers.ApplicationContext
import dagger.hilt.components.SingletonComponent
import javax.inject.Singleton

@Module
@InstallIn(SingletonComponent::class)
object AppModule {

    @Provides
    @Singleton
    fun provideAppPreferences(@ApplicationContext context: Context): AppPreferences {
        return AppPreferences(context)
    }

    @Provides
    @Singleton
    fun provideMomentumApiService(preferences: AppPreferences): MomentumApiService {
        return MomentumApiService.create(preferences)
    }
}
```

### Retrofit Setup with Self-Signed Cert Support

**MomentumApiService.kt** (`app/src/main/java/com/momentum/companion/data/api/MomentumApiService.kt`):
```kotlin
package com.momentum.companion.data.api

import com.momentum.companion.data.api.models.*
import com.momentum.companion.data.preferences.AppPreferences
import kotlinx.serialization.json.Json
import com.jakewharton.retrofit2.converter.kotlinx.serialization.asConverterFactory
import okhttp3.MediaType.Companion.toMediaType
import okhttp3.OkHttpClient
import okhttp3.logging.HttpLoggingInterceptor
import retrofit2.Retrofit
import retrofit2.http.*
import java.security.SecureRandom
import java.security.cert.X509Certificate
import javax.net.ssl.*

interface MomentumApiService {

    @POST("auth/login")
    suspend fun login(@Body request: LoginRequest): LoginResponse

    @POST("health-sync")
    suspend fun postHealthSync(
        @Header("Authorization") token: String,
        @Body request: HealthSyncRequest
    ): HealthSyncResponse

    @GET("health-sync/status")
    suspend fun getSyncStatus(
        @Header("Authorization") token: String
    ): SyncStatusResponse

    companion object {
        fun create(preferences: AppPreferences): MomentumApiService {
            val baseUrl = preferences.serverUrl ?: "https://localhost:3001/"

            val clientBuilder = OkHttpClient.Builder()
                .addInterceptor(HttpLoggingInterceptor().apply {
                    level = HttpLoggingInterceptor.Level.BODY
                })

            // Self-signed cert support
            if (preferences.allowSelfSignedCerts) {
                val trustAllCerts = arrayOf<TrustManager>(object : X509TrustManager {
                    override fun checkClientTrusted(chain: Array<X509Certificate>, authType: String) {}
                    override fun checkServerTrusted(chain: Array<X509Certificate>, authType: String) {}
                    override fun getAcceptedIssuers(): Array<X509Certificate> = arrayOf()
                })
                val sslContext = SSLContext.getInstance("TLS")
                sslContext.init(null, trustAllCerts, SecureRandom())
                clientBuilder.sslSocketFactory(sslContext.socketFactory, trustAllCerts[0] as X509TrustManager)
                clientBuilder.hostnameVerifier { _, _ -> true }
            }

            val json = Json { ignoreUnknownKeys = true }

            return Retrofit.Builder()
                .baseUrl(baseUrl)
                .client(clientBuilder.build())
                .addConverterFactory(json.asConverterFactory("application/json".toMediaType()))
                .build()
                .create(MomentumApiService::class.java)
        }
    }
}
```

### EncryptedSharedPreferences Setup

**AppPreferences.kt** (`app/src/main/java/com/momentum/companion/data/preferences/AppPreferences.kt`):
```kotlin
package com.momentum.companion.data.preferences

import android.content.Context
import android.content.SharedPreferences
import androidx.security.crypto.EncryptedSharedPreferences
import androidx.security.crypto.MasterKeys

class AppPreferences(context: Context) {
    private val masterKeyAlias = MasterKeys.getOrCreate(MasterKeys.AES256_GCM_SPEC)

    private val prefs: SharedPreferences = EncryptedSharedPreferences.create(
        "momentum_companion_prefs",
        masterKeyAlias,
        context,
        EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,
        EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM
    )

    var serverUrl: String?
        get() = prefs.getString("server_url", null)
        set(value) = prefs.edit().putString("server_url", value).apply()

    var jwtToken: String?
        get() = prefs.getString("jwt_token", null)
        set(value) = prefs.edit().putString("jwt_token", value).apply()

    var email: String?
        get() = prefs.getString("email", null)
        set(value) = prefs.edit().putString("email", value).apply()

    var password: String?
        get() = prefs.getString("password", null)
        set(value) = prefs.edit().putString("password", value).apply()

    var allowSelfSignedCerts: Boolean
        get() = prefs.getBoolean("allow_self_signed", false)
        set(value) = prefs.edit().putBoolean("allow_self_signed", value).apply()

    var lastSyncTimestamp: Long
        get() = prefs.getLong("last_sync_timestamp", 0L)
        set(value) = prefs.edit().putLong("last_sync_timestamp", value).apply()

    var syncFrequencyMinutes: Int
        get() = prefs.getInt("sync_frequency_minutes", 15)
        set(value) = prefs.edit().putInt("sync_frequency_minutes", value).apply()

    val isConfigured: Boolean
        get() = serverUrl != null && jwtToken != null

    fun clearAll() = prefs.edit().clear().apply()
}
```

### Compose Theme (Dark theme matching Momentum)

**Color.kt** (`app/src/main/java/com/momentum/companion/ui/theme/Color.kt`):
```kotlin
package com.momentum.companion.ui.theme

import androidx.compose.ui.graphics.Color

val MomentumBackground = Color(0xFF0A0A0A)      // #0a0a0a - near-black
val MomentumSurface = Color(0xFF171717)          // #171717 - dark card
val MomentumSurfaceVariant = Color(0xFF262626)   // #262626 - borders/dividers
val MomentumOrange = Color(0xFFF97316)           // #f97316 - primary accent
val MomentumOrangeLight = Color(0xFFFB923C)      // #fb923c - lighter accent
val MomentumTextPrimary = Color(0xFFFAFAFA)      // #fafafa - white text
val MomentumTextSecondary = Color(0xFFA3A3A3)    // #a3a3a3 - muted text
val MomentumGreen = Color(0xFF22C55E)            // ring: steps
val MomentumBlue = Color(0xFF3B82F6)             // ring: active minutes
val MomentumRed = Color(0xFFEF4444)              // ring: calories
val MomentumPurple = Color(0xFF8B5CF6)           // ring: sleep
val MomentumError = Color(0xFFEF4444)
```

**Theme.kt** (`app/src/main/java/com/momentum/companion/ui/theme/Theme.kt`):
```kotlin
package com.momentum.companion.ui.theme

import androidx.compose.material3.*
import androidx.compose.runtime.Composable

private val MomentumDarkColorScheme = darkColorScheme(
    primary = MomentumOrange,
    onPrimary = MomentumBackground,
    secondary = MomentumOrangeLight,
    background = MomentumBackground,
    surface = MomentumSurface,
    surfaceVariant = MomentumSurfaceVariant,
    onBackground = MomentumTextPrimary,
    onSurface = MomentumTextPrimary,
    onSurfaceVariant = MomentumTextSecondary,
    error = MomentumError,
)

@Composable
fun MomentumCompanionTheme(content: @Composable () -> Unit) {
    MaterialTheme(
        colorScheme = MomentumDarkColorScheme,
        content = content
    )
}
```

### Navigation Setup

**NavGraph.kt** (`app/src/main/java/com/momentum/companion/navigation/NavGraph.kt`):
```kotlin
package com.momentum.companion.navigation

import androidx.compose.runtime.Composable
import androidx.navigation.NavHostController
import androidx.navigation.compose.NavHost
import androidx.navigation.compose.composable

sealed class Screen(val route: String) {
    object Setup : Screen("setup")
    object Dashboard : Screen("dashboard")
    object Settings : Screen("settings")
}

@Composable
fun MomentumNavGraph(
    navController: NavHostController,
    isConfigured: Boolean
) {
    NavHost(
        navController = navController,
        startDestination = if (isConfigured) Screen.Dashboard.route else Screen.Setup.route
    ) {
        composable(Screen.Setup.route) {
            // SetupScreen(onSetupComplete = { navController.navigate(Screen.Dashboard.route) })
        }
        composable(Screen.Dashboard.route) {
            // DashboardScreen(onSettingsClick = { navController.navigate(Screen.Settings.route) })
        }
        composable(Screen.Settings.route) {
            // SettingsScreen(onBack = { navController.popBackStack() })
        }
    }
}
```

### Auth Flow

The Momentum API uses standard JWT auth. Login flow:

**Request**: `POST {serverUrl}/auth/login`
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**Response** (200 OK):
```json
{
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "name": "Elliot"
  }
}
```

On successful login:
1. Store the JWT token in EncryptedSharedPreferences
2. Store email and password for automatic re-login when token expires
3. Add `Authorization: Bearer <token>` header to all subsequent API calls
4. On 401 response from any endpoint, attempt automatic re-login using stored credentials

**Auth DTOs** (`app/src/main/java/com/momentum/companion/data/api/models/AuthModels.kt`):
```kotlin
@Serializable
data class LoginRequest(val email: String, val password: String)

@Serializable
data class LoginResponse(val token: String, val user: UserInfo)

@Serializable
data class UserInfo(val id: String, val email: String, val name: String)
```

### Project Structure (files to create in this story)
```
app/src/main/java/com/momentum/companion/
  MomentumApp.kt
  MainActivity.kt
  di/
    AppModule.kt
  data/
    api/
      MomentumApiService.kt
      models/
        AuthModels.kt
        HealthSyncRequest.kt   (stub only, implemented in 2.3)
        HealthSyncResponse.kt  (stub only, implemented in 2.3)
    preferences/
      AppPreferences.kt
  ui/
    setup/
      SetupScreen.kt
      SetupViewModel.kt
    theme/
      Color.kt
      Theme.kt
      Type.kt
  navigation/
    NavGraph.kt
```

### AndroidManifest.xml Key Additions
```xml
<application
    android:name=".MomentumApp"
    android:usesCleartextTraffic="false"
    ...>

    <!-- Health Connect intent filter for permission request -->
    <activity ...>
        <intent-filter>
            <action android:name="androidx.health.ACTION_SHOW_PERMISSIONS_RATIONALE" />
        </intent-filter>
    </activity>
</application>
```

### Testing
- Test framework: JUnit 5 + MockK
- Test location: `app/src/test/java/com/momentum/companion/`
- Tests for this story:
  - `SetupViewModelTest.kt`: test login success saves token, test login failure shows error, test validation prevents empty fields
  - `AppPreferencesTest.kt`: test read/write of all preference keys, test clearAll
  - Mock `MomentumApiService` using MockK for ViewModel tests

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1 | Initial creation | James (Dev) |

## Dev Agent Record
### Agent Model Used
[To be filled during implementation]

### Debug Log References
[None]

### Completion Notes
[None]

### File List
[To be populated during implementation]
